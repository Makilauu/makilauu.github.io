var sched={element:document.getElementsByClassName("sched")[0].getElementsByClassName("days")[0],url:"/api/sched",request:new Request,current:null,currentParams:{year:null,week:null,group:null},equalsCurrent:function(e,t,r){return e==this.currentParams.year&&t==this.currentParams.week&&r==this.currentParams.group},urlFor:function(e,t,r){return this.url+"/"+e+"/"+t+"/"+r},get:function(e,t,r,a,n){var s=this;if(this.equalsCurrent(e,t,r)){var i=JSON.parse(JSON.stringify(this.current));i.days=s.filter(i.days,a),n(!0,i)}else{this.currentParams={year:e,week:t,group:r};var u=this.stored(this.currentParams);u&&s.manageResponse({status:!0,sched:u},a,n),this.request.url=this.urlFor(e,t,r),this.request.success(function(e){e.status?(s.manageResponse(e,a,n),s.store(s.currentParams,e.sched)):n(e.status,e,null!==u)}).error(function(e){n(e.status,{message:"Erreur rÃ©seau"},null!==u)}).send()}},manageResponse:function(e,t,r){this.current=e.sched;var a=JSON.parse(JSON.stringify(e.sched));a.days=this.filter(a.days,t),r(e.status,a)},key:function(e){return"sched:"+api.institute+","+e.year+","+e.week+","+e.group},stored:function(e){var t=this.key(e);return local.get(t)},store:function(e,t){var r=this.key(e);return local.set(r,t)},compute:{duration:function(e){var t=60*(e.timeslot.end.hour-e.timeslot.begin.hour);return t-=e.timeslot.begin.minute,t+=e.timeslot.end.minute,t/=api.minuteInterval},maxNegative:function(e){var t=0;for(var r in e.negative){var a=e.negative[r];a>t&&(t=a)}return t}},filter:function(e,t){if(!Array.isArray(t))return e;if(0==t.length)return e;var r=[];for(var a in e){var n=e[a];r[a]=[];for(var s=0;s<n.length;s++)for(var i=n[s],u=!1,o=0;o<t.length;o++){var l=t[o],d=i[l.test];if(l.contain(d)&&l.dontContain(d)){if(!d.match(l.value)){u&&(r[a]=r[a].slice(0,-1));for(var c=0;c<i.parallels.length;c++)for(var m=0;m<n.length;m++){var h=n[m];h.id==i.parallels[c]&&(h.parallelCourses--,h.negative[i.id]=0)}break}u||(r[a].push(i),u=!0)}else u||(r[a].push(i),u=!0)}}return r},constructor:{insert:function(e){for(var t=0,r=0;r<api.days.length;r++){var a=api.days[r];Array.isArray(e[a])&&(sched.element.appendChild(this.day(e[a],a)),t++)}sched.element.setAttribute("data-week-length",t)},day:function(e,t){var r=document.createElement("article"),a=document.createElement("span"),n=document.createElement("div");r.className="day",a.className="name",n.className="courses",r.appendChild(a),r.appendChild(n),a.appendChild(document.createTextNode(t));for(var s={hour:api.hourBegin,minute:0},i=0;i<e.length;i++){var u=e[i];if(s.minute!=u.timeslot.begin.minute)if(s.hour==u.timeslot.begin.hour)for(var o=s.minute;o<u.timeslot.begin.minute;o+=api.minuteInterval)n.appendChild(this.hour(s.hour,o));else{for(var o=s.minute;o<60;o+=api.minuteInterval)n.appendChild(this.hour(s.hour,o));s.hour++}for(s.hour;s.hour<u.timeslot.begin.hour;s.hour++)for(var o=0;o<60;o+=api.minuteInterval)n.appendChild(this.hour(s.hour,o));n.appendChild(this.course(u)),s.hour=u.timeslot.end.hour,s.minute=u.timeslot.end.minute}return r},hour:function(e,t){var r=document.createElement("div");return r.className="hour",0!=t&&(r.className+=" minute"),t==api.middleMinute&&(r.className+=" middle"),r},course:function(e){var t=document.createElement("div"),r=document.createElement("div"),a=document.createElement("p"),n=document.createElement("span");if(t.className="course",t.setAttribute("data-parallel-courses",e.parallelCourses),t.setAttribute("data-parallel-factor",e.parallelFactor),t.setAttribute("data-duration",sched.compute.duration(e)),t.setAttribute("data-negative",sched.compute.maxNegative(e)),0!=e.timeslot.begin.minute&&e.timeslot.begin.minute!=api.middleMinute||t.setAttribute("data-begin-hour",!0),r.className="content",r.style.background=e.color,a.className="name",a.appendChild(n),n.appendChild(document.createTextNode(e.name)),t.appendChild(r),r.appendChild(a),e.professors.length>0||null!==e.classroom){var s=document.createElement("div");if(s.className="infos",r.appendChild(s),e.professors.length>0){var i=document.createElement("div");i.className="professors",s.appendChild(i);for(var u=0;u<e.professors.length;u++){var o=document.createElement("span");o.appendChild(document.createTextNode(e.professors[u])),i.appendChild(o)}}if(null!==e.classroom){var l=document.createElement("div");l.className="classroom",s.appendChild(l),l.appendChild(document.createTextNode(e.classroom))}}return t}},init:function(){this.request.json=!0}};sched.init();