// @import components/eventsManager
// @import components/Request
// @import components/result
// @import components/sched
// @import components/Spinner
// @import components/scroll
// @import components/Swipe
// @import components/standalone
// @import components/links
// @import components/RegParser
// @import components/local
var pageSched={spinner:new Spinner,swipe:new Swipe,days:document.getElementsByClassName("days")[0],breakpoint:1060,mobile:!1,weekParamLifetime:3e5,message:{element:document.createElement("span"),all:["Remerciez Satellys pour la latence...","Non, les cours ne sont pas annulés...","Ne partez pas ça devrait arriver...","Profitez-en pour vous servir un café...","C'est l'histoire de Jano Lapin...","L'temps passe, j'vois l'soleil s'lever, s'coucher...","Currently trying to make the world a better place...","Attention derrière toi...","L'accès Satellys j'l'ai pas loué..."],get random(){return this.all[Math.floor(Math.random()*this.all.length)]},set:function(){this.element.innerHTML="",this.element.appendChild(document.createTextNode(this.random))},init:function(){pageSched.spinner.element.appendChild(this.element)}},set loading(e){document.body.className=e?"loading":"",this.message.set(),e?this.spinner.show():this.spinner.hide()},get filters(){var e=this.form.groupFilters[this.form.group];if(void 0!==e&&null!==e)for(var t=this.form.filters,n=[],i=0;i<t.length;i++){var r=t[i];if(""!=r.value){var s=this.form.filtersData[e][r.name];n.push({test:s.test,contain:this.matcher(s.match),dontContain:this.matcher(s.dontMatch,!0),value:RegParser.compile(s.list[r.value])})}}return n},matcher:function(e,t){if("string"!=typeof e)return function(){return!0};var e=RegParser.compile(e);return t===!0?function(t){return null===t.match(e)}:function(t){return null!==t.match(e)}},update:function(e){this.form.update(),this.get(this.form.year,this.form.week,this.form.group,e)},clear:function(){this.days.innerHTML=""},form:{filtersData:api.filters,currentGroupFilters:null,groupFilters:api.groupFilters,element:document.getElementsByTagName("form")[0],filtersField:document.getElementsByTagName("form")[0].getElementsByClassName("filters")[0],inputs:{filters:document.getElementsByTagName("form")[0].getElementsByClassName("filters")[0].getElementsByTagName("select")},get group(){return this.inputs.group.value},get year(){return this.inputs.year.value},get week(){return this.inputs.week.value},get filters(){return Array.prototype.slice.call(this.inputs.filters).map(function(e){return{name:e.name,value:e.value}})},idForFilter:function(e){return"filter-"+e},update:function(){var e=this.groupFilters[this.group];if(e!=this.currentGroupFilters)if(this.currentGroupFilters=e,this.filtersField.innerHTML="",null!==e&&void 0!==e){var t=this.filtersData[e];if(void 0!==t){this.filtersField.removeAttribute("data-empty");for(var n in t){var i=t[n],r=document.createElement("div"),s=document.createElement("label"),a=document.createElement("select"),l=this.idForFilter(n);r.className="filter",s.appendChild(document.createTextNode(n)),s.setAttribute("for",l),a.name=n,a.id=l,a.on("change",this.onchange);var o=document.createElement("option");o.value="",o.appendChild(document.createTextNode("Aucun")),a.appendChild(o);for(var u in i.list){var o=document.createElement("option");o.value=u,o.appendChild(document.createTextNode(u)),a.appendChild(o)}r.appendChild(s),r.appendChild(a),this.filtersField.appendChild(r)}}}else{this.filtersField.setAttribute("data-empty",!0);var c=document.createElement("p");c.appendChild(document.createTextNode("Aucun filtre disponible")),this.filtersField.appendChild(c)}else this.saveFilters()},onchange:function(){pageSched.update()},saveFilters:function(){var e=this.groupFilters[this.group];if(null!==e&&void 0!==e){var t=this.filtersData[e];if(void 0!==t){var n={};for(var i in t)n[i]=document.getElementById(this.idForFilter(i)).value;local.set("filters",JSON.stringify(n))}}},loadFilters:function(){try{var e=JSON.parse(local.get("filters"))}catch(t){}if("object"==typeof e&&null!==e)for(var n in e){var i=document.getElementById(this.idForFilter(n));if(null!==i)for(var r=i.getElementsByTagName("option"),s=!1,a=0;a<r.length&&!s;a++){var l=r[a];l.getAttribute("value")==e[n]&&(l.setAttribute("selected",!0),s=!0)}}},init:function(){for(var e=this.element.getElementsByTagName("select"),t=0;t<e.length;t++){var n=e[t];"filter"!=n.parentNode.className&&(this.inputs[n.id.substr(6)]=n),n.on("change",this.onchange)}var i=local.get("week");if(null!==i)for(var r=this.inputs.week.getElementsByTagName("option"),t=0;t<r.length;t++){var s=r[t];s.value==i?s.setAttribute("selected",!0):s.removeAttribute("selected")}this.update(),this.loadFilters()}},quote:{element:null,sibling:document.getElementsByClassName("sched")[0],request:new Request("/quote/current"),get parent(){return this.sibling.parentNode},get expiration(){var e=new Date;return e.setDate(e.getDate()+1),e.getTime()},get:function(e){var t=local.get("quote");null!==t&&e(t,!0),this.request.success(function(t){t.status&&(null!==t.quote?(e(t.quote),local.set("quote",t.quote,null,this.expiration)):local.remove("quote"))}).send()},append:function(e,t){null==this.element?(this.element=this.create(e,t),this.parent.insertBefore(this.element,this.sibling)):(this.element.innerHTML="",this.element.appendChild(this.content(e)))},create:function(e,t){var n=document.createElement("div");return n.className="quote"+(t?" static":""),n.appendChild(this.content(e)),n},content:function(e){var t=document.createElement("div");t.className="wrapper";var n=document.createElement("span");n.className="content";var i=document.createElement("span");return i.className="author",n.innerHTML=this.cleaner.htmlFor(e.content),i.innerHTML=null===e.author?"Anonyme":this.cleaner.htmlFor(e.author),t.appendChild(n),t.innerHTML+="&nbsp;—&nbsp;",t.appendChild(i),t},cleaner:{escape:function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},unbreakPunctuation:function(e){return e=e.replace(/\s([\?!:;])/g,"&nbsp;$1"),e=e.replace(/\s-/g,"&nbsp;-"),e=e.replace(/-\s/g,"-&nbsp;"),e=e.replace(/-/g,"&#8209;")},htmlFor:function(e){return e=this.escape(e),e=this.unbreakPunctuation(e)}},init:function(){var e=this;this.request.json=!0,this.get(function(t,n){e.append(t,n)})}},get:function(e,t,n,i){var r=this;this.loading=!0,"function"!=typeof i&&(i=function(){}),sched.get(e,t,n,this.filters,function(e,t,n){e?(r.clear(),sched.constructor.insert(t.days),r.onresize(),r.form.week==api.defaultWeek&&r.mobile&&(r.swipe.page=api.defaultDay-1),local.set("week",r.form.week,r.weekParamLifetime),i()):(result.set(t.message),n||r.clear()),r.loading=!1})},onresize:function(e){if(window.innerWidth>this.breakpoint&&(this.mobile||e===!0)){this.swipe.disabled=!0;var t=this.swipe.firstElement;t&&(t.style.marginLeft="0px"),this.mobile=!1}else window.innerWidth<=this.breakpoint&&(!this.mobile||e===!0)&&(this.mobile=!0,this.swipe.disabled=!1)},init:function(){var e=this;on("resize",function(){e.onresize()}),this.swipe.element=this.days,this.swipe.init(),this.message.init(),this.form.init(),this.quote.init(),this.onresize(!0),this.update()}};pageSched.init();